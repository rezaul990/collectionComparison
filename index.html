<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Branch-wise Overdue Comparison with Google Drive (Folder-based)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container { 
      max-width: 1400px; 
      margin: auto; 
      background: white; 
      padding: 30px; 
      border-radius: 15px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    h1 { 
      text-align: center; 
      border-bottom: 3px solid #4CAF50; 
      padding-bottom: 15px; 
      margin-bottom: 30px;
      color: #333;
      font-size: 2.5em;
      font-weight: 300;
    }
    h2 { 
      margin-top: 40px; 
      border-left: 4px solid #4CAF50; 
      padding-left: 15px; 
      color: #333;
      font-weight: 400;
    }
    h3 {
      margin-top: 25px;
      margin-bottom: 15px;
      color: #444;
      font-weight: 500;
      font-size: 1.25em;
    }
    .header-section {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #4CAF50;
    }
    .header-actions {
      margin-top: 15px;
    }
    .main-section {
      margin: 30px 0;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px solid #e9ecef;
    }
    .section-title {
      font-size: 1.75em;
      font-weight: 600;
      margin: 0 0 25px 0;
      padding-bottom: 12px;
      border-bottom: 2px solid #4CAF50;
      color: #333;
      border-left: none;
      padding-left: 0;
    }
    .section { 
      background: white; 
      padding: 20px; 
      border-radius: 10px; 
      margin: 20px 0; 
      border: 1px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .file-input-group {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    .file-input-group input[type="file"] {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      border: 2px dashed #4CAF50;
      border-radius: 8px;
      background: white;
      cursor: pointer;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    button { 
      margin: 5px; 
      padding: 12px 24px; 
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    button:hover:not(:disabled) { 
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    button:disabled { 
      background: #ccc; 
      cursor: not-allowed; 
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: linear-gradient(45deg, #6c757d, #5a6268);
    }
    .btn-danger {
      background: linear-gradient(45deg, #dc3545, #c82333);
    }
    .btn-info {
      background: linear-gradient(45deg, #17a2b8, #138496);
    }
    .status { 
      padding: 15px; 
      margin: 15px 0; 
      border-radius: 8px; 
      font-weight: 500;
      border-left: 4px solid;
    }
    .success {
      background: #d4edda; 
      color: #155724;
      border-left-color: #28a745;
    }
    .error {
      background: #f8d7da; 
      color: #721c24;
      border-left-color: #dc3545;
    }
    .info {
      background: #d1ecf1; 
      color: #0c5460;
      border-left-color: #17a2b8;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border-left-color: #ffc107;
    }
    /* Urgent warning card for 180+ days */
    .warning-card {
      background: #fff7e6; /* light amber */
      border-left: 6px solid #ff8c00; /* deep orange */
      box-shadow: 0 10px 20px rgba(255,140,0,0.15);
      padding: 20px;
      border-radius: 12px;
      margin: 25px 0;
    }
    .warning-card h3 {
      margin-top: 0;
      color: #9a5b00;
      border-left: none;
      padding-left: 0;
      font-size: 1.3em;
    }
    .warning-card .note {
      background: #fff0cc;
      border-left: 4px solid #ffb84d;
      color: #7a4a00;
      padding: 10px 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 13px;
    }
    table { 
      border-collapse: collapse; 
      width: 100%; 
      margin-top: 15px; 
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    th, td { 
      border: 1px solid #dee2e6; 
      padding: 14px; 
      font-size: 15px; 
      text-align: left;
      font-variant-numeric: tabular-nums; /* clearer, aligned digits */
    }
    th { 
      background: linear-gradient(45deg, #4CAF50, #45a049); 
      color: white; 
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    tr:hover {
      background-color: #e3f2fd;
    }
    /* Make numbers pop anywhere we right/center-align them inline */
    td[style*="text-align:right"],
    td[style*="text-align:center"] {
      color: #111827; /* high-contrast gray-900 */
      font-weight: 600;
    }
    /* Totals rows more eye-catching */
    tr[style*="font-weight:bold"],
    td[style*="font-weight:bold"] {
      font-weight: 700 !important;
      color: #0f5132; /* deep green for emphasis */
    }
    /* Low-performing branches (lowest 10 Coll %) - enhanced readability */
    tr[style*="background-color:#ffebee"] {
      font-weight: 700 !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    tr[style*="background-color:#ffebee"] td {
      font-weight: 700 !important;
      color: #1a1a1a !important;
      font-size: 15px;
      letter-spacing: 0.1px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    tr[style*="background-color:#ffebee"] td[style*="color: #d32f2f"] {
      color: #c62828 !important;
      font-weight: 800 !important;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background-color: #e9ecef;
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, #4CAF50, #45a049);
      width: 0%;
      transition: width 0.3s ease;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #4CAF50;
    }
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #4CAF50;
    }
    .stat-label {
      color: #666;
      margin-top: 5px;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .filter-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px;
      background: #f0f0f0;
      border-radius: 8px;
    }
    .filter-controls input[type="text"],
    .filter-controls select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      min-width: 150px;
    }
    .filter-controls input[type="text"] {
      flex: 1;
      min-width: 200px;
    }
    .filter-controls select {
      min-width: 180px;
    }
    .filter-controls select[multiple] {
      min-width: 220px;
      padding: 4px 8px;
      background: white;
      cursor: pointer;
    }
    .filter-controls select[multiple] option {
      padding: 6px 8px;
      border-radius: 4px;
      margin: 2px 0;
    }
    .filter-controls select[multiple] option:checked {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      font-weight: 600;
    }
    .local-master-option {
      margin: 15px 0;
      padding: 10px;
      background: #fff9e6;
      border-radius: 6px;
      border-left: 3px solid #ffc107;
    }
    .local-master-option label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 500;
    }
    .warning-description {
      margin: 8px 0 12px;
      color: #5c3a00;
      line-height: 1.6;
    }
    .sub-section-title {
      margin: 15px 0 8px;
      color: #5c3a00;
      font-size: 1.1em;
    }
    .responsive-table {
      overflow-x: auto;
    }
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 10px;
      }
      h1 {
        font-size: 2em;
      }
      .main-section {
        padding: 15px;
        margin: 20px 0;
      }
      .section-title {
        font-size: 1.5em;
      }
      .file-input-group {
        flex-direction: column;
        align-items: stretch;
      }
      .button-group {
        justify-content: center;
        flex-direction: column;
      }
      button {
        flex: 1;
        min-width: 120px;
        width: 100%;
      }
      .filter-controls {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-controls input[type="text"],
      .filter-controls select {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Header Section -->
  <div class="header-section">
    <h1>üìä Collection Comparison (Total, Yearly, Monthly)</h1>
    <div class="header-actions">
      <button onclick="showHelp()" class="btn-info">üìñ Help & Instructions</button>
    </div>
  </div>

  <!-- Setup Section -->
  <div class="main-section">
    <h2 class="section-title">‚öôÔ∏è Setup & Configuration</h2>
    
    <!-- Authentication Section -->
    <div class="section">
      <h3>üîê Google Drive Authentication</h3>
      <div class="button-group">
        <button id="signinBtn">
          <span id="signinText">Sign in with Google</span>
          <span id="signinLoading" class="loading" style="display:none;"></span>
        </button>
        <button id="signoutBtn" class="btn-secondary" style="display:none;">Sign out</button>
      </div>
      <div id="status" class="status info">Not signed in.</div>
    </div>

    <!-- Master File Section -->
    <div class="section">
      <h3>üìÅ Master File (stored in Drive Folder)</h3>
      <div class="tooltip">
        <span class="tooltiptext">Upload your master Excel file to Google Drive. This file will be used as the baseline for comparison. The file will be stored securely in your Google Drive.</span>
        ‚ÑπÔ∏è
      </div>
      <div class="file-input-group">
        <input type="file" id="masterFile" accept=".xlsx,.xls" />
        <div class="button-group">
          <button id="uploadMasterBtn" disabled>
            <span id="uploadText">Upload/Replace Master</span>
            <span id="uploadLoading" class="loading" style="display:none;"></span>
          </button>
          <button id="deleteMasterBtn" class="btn-danger" disabled>Delete Master</button>
        </div>
      </div>
      <div class="progress-bar" id="uploadProgress" style="display:none;">
        <div class="progress-fill" id="uploadProgressFill"></div>
      </div>
    </div>

    <!-- Daily File Section -->
    <div class="section">
      <h3>üìÑ Daily File (Local)</h3>
      <div class="tooltip">
        <span class="tooltiptext">Select your daily Excel file to compare against the master file. This file should have the same structure as the master file.</span>
        ‚ÑπÔ∏è
      </div>
      <div class="file-input-group">
        <input type="file" id="dailyFile" accept=".xlsx,.xls" />
        <div class="button-group">
          <button id="processBtn" disabled>
            <span id="processText">Process Comparison</span>
            <span id="processLoading" class="loading" style="display:none;"></span>
          </button>
          <button id="downloadBtn" class="btn-info" disabled>Download Results Excel</button>
        </div>
      </div>
      <div class="local-master-option">
        <label><input type="checkbox" id="useLocalMaster"> Use local master instead of Drive</label>
        <input type="file" id="localMasterFile" accept=".xlsx,.xls" style="margin-left:10px; display:none;" />
      </div>
      <div class="progress-bar" id="processProgress" style="display:none;">
        <div class="progress-fill" id="processProgressFill"></div>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div id="resultsSection" style="display:none;">
    <!-- Statistics Dashboard -->
    <div class="main-section">
      <h2 class="section-title">üìà Statistics Dashboard</h2>
      <div class="section" id="statsSection">
        <div class="stats-grid" id="statsGrid"></div>
      </div>
    </div>

    <!-- Summary & Analysis -->
    <div class="main-section">
      <h2 class="section-title">üìä Summary & Analysis</h2>
      
      <!-- Branch Summary -->
      <div class="section">
        <h3>Branch Summary</h3>
        <div class="filter-controls">
          <input type="text" id="branchSearch" placeholder="Search branches..." />
          <select id="sortBy">
            <option value="branch">Sort by Branch</option>
            <option value="collectible">Sort by Collectible</option>
            <option value="collected">Sort by Collected</option>
            <option value="percentage">Sort by Collection %</option>
            <option value="amount">Sort by Amount</option>
          </select>
          <button onclick="resetFilters()" class="btn-secondary">Reset Filters</button>
          <select id="themeBranchSummary" style="padding: 8px; border-radius: 6px; font-weight: 600;">
            <option value="dark">Dark Teal</option>
            <option value="light">White/Black</option>
          </select>
          <button id="shotBranchSummary" class="btn-secondary" disabled>Capture Screenshot</button>
        </div>
        <div class="responsive-table">
          <div id="summary"></div>
        </div>
      </div>

      <!-- Branch-Year Pivot -->
      <div class="section">
        <h3>üìÖ Branch-Year Not Collected Qty</h3>
        <div class="filter-controls">
          <input type="text" id="pivotSearch" placeholder="Search branches..." />
          <select id="yearFilter" multiple size="5" style="min-width: 200px; height: auto;">
            <option value="">All Years</option>
          </select>
          <select id="themeBranchYear" style="padding: 8px; border-radius: 6px; font-weight: 600;">
            <option value="dark">Dark Teal</option>
            <option value="light">White/Black</option>
          </select>
          <button id="shotBranchYear" class="btn-secondary" disabled>Capture Screenshot</button>
        </div>
        <div class="responsive-table">
          <div id="pivot"></div>
        </div>
      </div>
    </div>

    <!-- Monthly Analysis -->
    <div class="main-section">
      <h2 class="section-title">üìÖ Monthly Analysis</h2>
      
      <!-- 2024 Monthly -->
      <div class="section">
        <h3>2024 - Branch & Month Wise Not Collected Qty</h3>
        <div class="button-group">
          <button id="download2024MonthlyBtn" disabled>Download 2024 Monthly Not Collected (List)</button>
          <select id="theme2024" style="padding: 8px; border-radius: 6px; font-weight: 600;">
            <option value="dark">Dark Teal</option>
            <option value="light">White/Black</option>
          </select>
          <button id="shot2024" class="btn-secondary" disabled>Capture Screenshot</button>
        </div>
        <div class="responsive-table">
          <div id="pivot2024Monthly"></div>
        </div>
      </div>

      <!-- 2025 Monthly -->
      <div class="section">
        <h3>2025 - Branch & Month Wise Not Collected Qty</h3>
        <div class="button-group">
          <button id="download2025MonthlyBtn" disabled>Download 2025 Monthly Not Collected (List)</button>
          <select id="theme2025" style="padding: 8px; border-radius: 6px; font-weight: 600;">
            <option value="dark">Dark Teal</option>
            <option value="light">White/Black</option>
          </select>
          <button id="shot2025" class="btn-secondary" disabled>Capture Screenshot</button>
        </div>
        <div class="responsive-table">
          <div id="pivot2025Monthly"></div>
        </div>
      </div>
    </div>

    <!-- Overdue Accounts -->
    <div class="main-section">
      <h2 class="section-title">‚ö†Ô∏è Overdue Accounts</h2>
      
      <!-- 180+ Days Overdue -->
      <div class="warning-card" id="overdue180Section" style="display:none;">
        <h3>‚è≥ Accounts Beyond 180 Days (Uncollected with Balance)</h3>
        <p class="warning-description">Branch-wise summary of accounts ‚â• 180 days from Sale_Date with non-zero Closing (daily file). Detailed list is available via download.</p>
        <div class="responsive-table" id="overdue180Summary"></div>
        <p class="sub-section-title"><strong>Branch-Year Summary</strong></p>
        <div class="responsive-table" id="overdue180ByYear"></div>
        <div class="note">Accounts with zero balance (Closing = 0) are excluded from this section.</div>
        <div class="button-group" style="margin-top:15px;">
          <button id="downloadOverdue180Btn" class="btn-info" disabled>Download 180+ Days Accounts</button>
        </div>
      </div>

      <!-- 180-195 Days Overdue -->
      <div class="warning-card" id="overdue180_195Section" style="display:none;">
        <h3>‚è≥ Accounts 180‚Äì195 Days (Uncollected with Balance)</h3>
        <p class="warning-description">Branch-wise summary of accounts between 180 and 195 days from Sale_Date with non-zero Closing (daily file). Detailed list is available via download.</p>
        <div class="responsive-table" id="overdue180_195Summary"></div>
        <div class="note">Accounts with zero balance (Closing = 0) are excluded from this section.</div>
        <div class="button-group" style="margin-top:15px;">
          <button id="downloadOverdue180_195Btn" class="btn-info" disabled>Download 180‚Äì195 Days Accounts</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div id="helpModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
  <div style="background-color: white; margin: 5% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">üìñ Help & Instructions</h2>
      <button onclick="hideHelp()" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">√ó</button>
    </div>
    
    <div style="line-height: 1.6;">
      <h3>üöÄ Getting Started</h3>
      <ol>
        <li><strong>Sign in with Google:</strong> Click the "Sign in with Google" button to authenticate with your Google account.</li>
        <li><strong>Upload Master File:</strong> Select and upload your master Excel file to Google Drive.</li>
        <li><strong>Select Daily File:</strong> Choose your daily Excel file for comparison.</li>
        <li><strong>Process Comparison:</strong> Click "Process Comparison" to analyze the data.</li>
        <li><strong>Download Results:</strong> Export the results to Excel format.</li>
      </ol>

      <h3>üìã Required Excel Format</h3>
      <p>Your Excel files should contain these columns (case-insensitive):</p>
      <ul>
        <li><strong>Branch/Plaza/Division/Area:</strong> Branch identifier</li>
        <li><strong>Account Number/Account_No/Code:</strong> Account identifier</li>
        <li><strong>Customer Name/Customer_Name/Name:</strong> Customer name</li>
        <li><strong>Overdue/Opening/Closing:</strong> Overdue amount</li>
        <li><strong>Credit/Cr/Amount Received/Payment:</strong> Credit amount</li>
        <li><strong>Sale Date/Sale_Date/Date:</strong> Sale date</li>
      </ul>

      <h3>üîç Features</h3>
      <ul>
        <li><strong>Search & Filter:</strong> Use the search boxes to find specific branches</li>
        <li><strong>Sort Results:</strong> Sort by different criteria (branch, collectible, collected, percentage, amount)</li>
        <li><strong>Year Filtering:</strong> Filter pivot table by specific years</li>
        <li><strong>Statistics Dashboard:</strong> View quick statistics at a glance</li>
        <li><strong>Export Options:</strong> Download comprehensive Excel reports with multiple sheets</li>
      </ul>

      <h3>‚ö†Ô∏è Troubleshooting</h3>
      <ul>
        <li><strong>Authentication Issues:</strong> Ensure pop-ups are allowed and try refreshing the page</li>
        <li><strong>File Upload Problems:</strong> Check file size (max 50MB) and format (.xlsx or .xls)</li>
        <li><strong>Processing Errors:</strong> Verify your Excel files have the correct column headers</li>
        <li><strong>No Data Found:</strong> Ensure your files contain data rows after the header</li>
      </ul>

      <h3>üîí Security & Privacy</h3>
      <ul>
        <li>All authentication is handled securely by Google</li>
        <li>Files are stored in your personal Google Drive</li>
        <li>No data is sent to external servers except Google's APIs</li>
        <li>You can revoke access anytime through your Google account</li>
      </ul>
    </div>
  </div>
</div>

<script>
/* ===== Google OAuth & Drive setup ===== */
const CLIENT_ID = "754850424503-gj010h380qhlctrolg8rrjhd323101v5.apps.googleusercontent.com";
const API_KEY   = "YOUR_API_KEY";
const SCOPES = "https://www.googleapis.com/auth/drive.file";
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

let tokenClient, accessToken=null, masterFileId=null, masterFolderId=null;

gapi.load("client", async () => {
  await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
});

window.onload = () => {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (resp) => {
      hideLoading("signinLoading", "signinText", "Signing in...");
      if(resp.error){ showStatus("Authentication failed: " + resp.error,"error"); return; }
      accessToken = resp.access_token;
      localStorage.setItem("access_token",accessToken);
      updateSignin(true);
    }
  });

  document.getElementById("signinBtn").onclick=()=>{
    showLoading("signinLoading", "signinText", "Signing in...");
    tokenClient.requestAccessToken({prompt:'consent'});
  };
  document.getElementById("signoutBtn").onclick=signOut;
  document.getElementById("uploadMasterBtn").onclick=uploadMasterFile;
  document.getElementById("deleteMasterBtn").onclick=deleteMasterFile;
  document.getElementById("processBtn").onclick=processFiles;
  document.getElementById("downloadBtn").onclick=downloadExcel;
  
  // Toggle local master input
  const useLocal = document.getElementById("useLocalMaster");
  const localMaster = document.getElementById("localMasterFile");
  useLocal.addEventListener("change", () => {
    localMaster.style.display = useLocal.checked ? "inline-block" : "none";
  });
  
  // Add file validation
  document.getElementById("masterFile").addEventListener("change", validateMasterFile);
  document.getElementById("dailyFile").addEventListener("change", validateDailyFile);
  
  // Add filtering event listeners
  document.getElementById("branchSearch").addEventListener("input", filterSummary);
  document.getElementById("sortBy").addEventListener("change", filterSummary);
  document.getElementById("pivotSearch").addEventListener("input", filterPivot);
  document.getElementById("yearFilter").addEventListener("change", filterPivot);

  if(localStorage.getItem("access_token")) {
    accessToken=localStorage.getItem("access_token");
    updateSignin(true);
  }
};

function updateSignin(isIn=true){
  if(isIn){
    document.getElementById("signinBtn").style.display="none";
    document.getElementById("signoutBtn").style.display="inline-block";
    document.getElementById("uploadMasterBtn").disabled=false;
    document.getElementById("deleteMasterBtn").disabled=false;
    document.getElementById("processBtn").disabled=false;
    showStatus("Signed in successfully!","success");
    ensureMasterFolder().then(findMasterFile);
  } else {
    document.getElementById("signinBtn").style.display="inline-block";
    document.getElementById("signoutBtn").style.display="none";
    document.getElementById("uploadMasterBtn").disabled=true;
    document.getElementById("deleteMasterBtn").disabled=true;
    document.getElementById("processBtn").disabled=true;
    document.getElementById("downloadBtn").disabled=true;
    document.getElementById("statsSection").style.display="none";
    document.getElementById("resultsSection").style.display="none";
    showStatus("Not signed in","info");
  }
}
function signOut(){ if(accessToken) google.accounts.oauth2.revoke(accessToken); accessToken=null; localStorage.clear(); updateSignin(false); }
function showStatus(msg,type){const s=document.getElementById("status"); s.textContent=msg; s.className="status "+type;}

/* ===== UI Helper Functions ===== */
function showLoading(loadingId, textId, loadingText) {
  document.getElementById(loadingId).style.display = "inline-block";
  document.getElementById(textId).textContent = loadingText;
}

function hideLoading(loadingId, textId, originalText) {
  document.getElementById(loadingId).style.display = "none";
  document.getElementById(textId).textContent = originalText;
}

function showProgress(progressId, fillId, initialPercent = 0) {
  document.getElementById(progressId).style.display = "block";
  updateProgress(fillId, initialPercent);
}

function hideProgress(progressId) {
  document.getElementById(progressId).style.display = "none";
}

function updateProgress(fillId, percent) {
  document.getElementById(fillId).style.width = percent + "%";
}

/* ===== Security Functions ===== */
function sanitizeInput(input) {
  if (typeof input !== 'string') return input;
  return input
    .replace(/[<>]/g, '') // Remove potential HTML tags
    .replace(/javascript:/gi, '') // Remove javascript: protocol
    .replace(/on\w+=/gi, '') // Remove event handlers
    .trim();
}

/* ===== File Validation ===== */
function validateMasterFile() {
  const file = document.getElementById("masterFile").files[0];
  if (!file) return;
  
  const validTypes = ['.xlsx', '.xls'];
  const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
  
  if (!validTypes.includes(fileExtension)) {
    showStatus("Please select a valid Excel file (.xlsx or .xls) for the master file","error");
    document.getElementById("masterFile").value = "";
    return;
  }
  
  if (file.size > 50 * 1024 * 1024) { // 50MB limit
    showStatus("Master file is too large. Please select a file smaller than 50MB","error");
    document.getElementById("masterFile").value = "";
    return;
  }
  
  showStatus(`Master file selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`,"info");
}

function validateDailyFile() {
  const file = document.getElementById("dailyFile").files[0];
  if (!file) return;
  
  const validTypes = ['.xlsx', '.xls'];
  const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
  
  if (!validTypes.includes(fileExtension)) {
    showStatus("Please select a valid Excel file (.xlsx or .xls) for the daily file","error");
    document.getElementById("dailyFile").value = "";
    return;
  }
  
  if (file.size > 50 * 1024 * 1024) { // 50MB limit
    showStatus("Daily file is too large. Please select a file smaller than 50MB","error");
    document.getElementById("dailyFile").value = "";
    return;
  }
  
  showStatus(`Daily file selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`,"info");
}

/* ===== Folder Handling ===== */
async function ensureMasterFolder(){
  try {
    const res=await fetch("https://www.googleapis.com/drive/v3/files?q=name='BranchManagerApp_Folder' and mimeType='application/vnd.google-apps.folder' and trashed=false&fields=files(id,name)", {
      headers:{Authorization:"Bearer "+accessToken}
    });
    const data=await res.json();
    if(data.files && data.files.length>0){
      masterFolderId=data.files[0].id;
    } else {
      const createRes=await fetch("https://www.googleapis.com/drive/v3/files", {
        method:"POST", headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},
        body: JSON.stringify({name:"BranchManagerApp_Folder",mimeType:"application/vnd.google-apps.folder"})
      });
      const folder=await createRes.json();
      masterFolderId=folder.id;
    }
    localStorage.setItem("masterFolderId",masterFolderId);
    return masterFolderId;
  } catch(e){ console.error("ensureMasterFolder error",e); showStatus("Error with folder","error"); }
}

async function findMasterFile(){
  try {
    if(!masterFolderId) masterFolderId=localStorage.getItem("masterFolderId");
    if(!masterFolderId) return;
    const res=await fetch(`https://www.googleapis.com/drive/v3/files?q='${masterFolderId}'+in+parents and trashed=false&orderBy=modifiedTime desc&fields=files(id,name,modifiedTime)`, {
      headers:{Authorization:"Bearer "+accessToken}
    });
    const data=await res.json();
    if(data.files && data.files.length>0){
      const f=data.files[0];
      masterFileId=f.id;
      localStorage.setItem("masterFileId", masterFileId);
      showStatus("Master detected: "+f.name,"success");
    } else {
      masterFileId=null;
      showStatus("No Master file in folder. Upload one.","info");
    }
  } catch(e){ console.error("findMasterFile error",e); showStatus("Error finding Master","error"); }
}

async function uploadMasterFile(){
  const file=document.getElementById("masterFile").files[0]; 
  if(!file) return showStatus("Please select a file to upload","error");
  
  // Show loading state
  showLoading("uploadLoading", "uploadText", "Uploading...");
  showProgress("uploadProgress", "uploadProgressFill", 0);
  
  try {
  const folderId=await ensureMasterFolder();
  const meta={name:file.name, mimeType:file.type, parents:[folderId]};
  const fd=new FormData();
  fd.append("metadata", new Blob([JSON.stringify(meta)],{type:"application/json"}));
  fd.append("file", file);
    
    // Simulate progress
    updateProgress("uploadProgressFill", 50);
    
  const res=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
    method:"POST", headers:{Authorization:"Bearer "+accessToken}, body:fd
  });
    
    if(!res.ok) throw new Error(`Upload failed: ${res.status} ${res.statusText}`);
    
  const j=await res.json();
  masterFileId=j.id;
  localStorage.setItem("masterFileId", masterFileId);
    
    updateProgress("uploadProgressFill", 100);
    showStatus("Master file uploaded successfully: "+j.name,"success");
    
  } catch(error) {
    showStatus("Upload failed: " + error.message,"error");
    console.error("Upload error:", error);
  } finally {
    hideLoading("uploadLoading", "uploadText", "Upload/Replace Master");
    setTimeout(() => hideProgress("uploadProgress"), 2000);
  }
}
async function downloadMasterFile(){
  if(!masterFileId) throw new Error("No Master file");
  const res=await fetch("https://www.googleapis.com/drive/v3/files/"+masterFileId+"?alt=media",{headers:{Authorization:"Bearer "+accessToken}});
  return await res.arrayBuffer();
}
async function deleteMasterFile(){
  if(!masterFileId) return;
  await fetch("https://www.googleapis.com/drive/v3/files/"+masterFileId,{method:"DELETE",headers:{Authorization:"Bearer "+accessToken}});
  localStorage.removeItem("masterFileId"); masterFileId=null;
  showStatus("Master deleted","info");
}

/* ===== SheetJS Helpers ===== */
function toNumberSafe(val){ if(val==null||val==="") return 0; if(typeof val==="number") return val; const c=val.toString().replace(/,/g,'').trim(); return isNaN(c)?0:Number(c);}
function normalizeHeader(header){
  if(!header) return "";
  const h=header.toString().toLowerCase().trim();
  if(["branch","plaza","plaza name","plaza_name","division","area"].includes(h)) return "branch";
  if(["account","account number","account_no","account no","account_number","code"].includes(h)) return "account";
  if(["customer","customer name","customer_name","name"].includes(h)) return "customer";
  if(["overdue","opening"].includes(h)) return "overdue";
  if(["closing","closing balance","balance"].includes(h)) return "closing";
  if(["credit","cr","amount received","amountreceived","payment"].includes(h)) return "credit";
  if(["debit","dr"].includes(h)) return "debit";
  if(["sale_date","sale date","saledate","date"].includes(h)) return "sale_date";
  return h;
}
function findHeaderRow(raw){ 
  for(let i=0;i<raw.length;i++){ 
    const row=raw[i].map(x=>(x||"").toString().toLowerCase().trim()); 
    if(row.includes("branch")||row.includes("plaza")||row.includes("account number")||row.includes("customer name")||row.includes("credit")) 
      return i; 
  } 
  return -1; 
}
function parseWorkbook(buffer){
  try {
    const wb=XLSX.read(buffer,{type:"array"}); 
    if(!wb.SheetNames || wb.SheetNames.length === 0) {
      throw new Error("No worksheets found in the Excel file");
    }
    
    const ws=wb.Sheets[wb.SheetNames[0]];
    if(!ws) {
      throw new Error("First worksheet is empty or corrupted");
    }
    
  const raw=XLSX.utils.sheet_to_json(ws,{header:1});
    if(!raw || raw.length === 0) {
      throw new Error("No data found in the worksheet");
    }
    
    const hri=findHeaderRow(raw); 
    if(hri === -1) {
      throw new Error("Could not find header row with expected columns");
    }
    
    const headers=raw[hri].map(h=>normalizeHeader(h));
    const data = raw.slice(hri+1).map((r, index) => {
      const o={}; 
      headers.forEach((h,i) => {
        o[h] = ["overdue","credit","opening","debit","closing"].includes(h) ? toNumberSafe(r[i]) : r[i];
      }); 
      o._rowIndex = index + hri + 2; // Excel row number for error reporting
      return o;
    }).filter(row => {
      // Filter out completely empty rows
      return Object.values(row).some(val => val !== null && val !== undefined && val !== "");
    });
    
    if(data.length === 0) {
      throw new Error("No valid data rows found after header");
    }
    
    return data;
  } catch(error) {
    console.error("Parse workbook error:", error);
    throw new Error(`Failed to parse Excel file: ${error.message}`);
  }
}
function readLocalFile(file){ return new Promise(res=>{const r=new FileReader(); r.onload=e=>res(parseWorkbook(e.target.result)); r.readAsArrayBuffer(file);}); }
function makeKey(r){ return `${(r.branch||"").toString().trim().toLowerCase()}|${(r.account||"").toString().trim().toLowerCase()}|${(r.customer||"").toString().trim().toLowerCase()}`; }
function getYear(val){ if(!val) return "Unknown"; if(typeof val==="number"){ const d=XLSX.SSF.parse_date_code(val); return d?d.y:"Unknown"; } const d=new Date(val); return !isNaN(d)?d.getFullYear():"Unknown"; }
function getMonth(val){
  if(!val) return "Unknown";
  if(typeof val === "number"){
    const d = XLSX.SSF.parse_date_code(val);
    if(d && typeof d.m === "number") return d.m; // 1-12
    const dd = new Date((val - 25569) * 86400 * 1000);
    return isNaN(dd) ? "Unknown" : (dd.getMonth()+1);
  }
  const d = new Date(val);
  return isNaN(d) ? "Unknown" : (d.getMonth()+1); // 1-12
}

function excelValueToDate(value){
  if(!value) return null;
  if(typeof value === "number"){
    const parsed = XLSX.SSF.parse_date_code(value);
    if(parsed && typeof parsed.y === "number"){
      const d = new Date(parsed.y, (parsed.m||1)-1, parsed.d||1);
      return isNaN(d)? null : d;
    }
    const d2 = new Date((value - 25569) * 86400 * 1000);
    return isNaN(d2)? null : d2;
  }
  const d = new Date(value);
  return isNaN(d)? null : d;
}

function monthsBetween(startDate, endDate){
  if(!startDate || !endDate) return 0;
  const sY = startDate.getFullYear();
  const sM = startDate.getMonth();
  const eY = endDate.getFullYear();
  const eM = endDate.getMonth();
  let months = (eY - sY) * 12 + (eM - sM);
  // adjust if end day is before start day
  if(endDate.getDate() < startDate.getDate()) months -= 1;
  return months < 0 ? 0 : months;
}

function daysBetween(startDate, endDate){
  if(!startDate || !endDate) return 0;
  const ms = endDate.setHours(0,0,0,0) - startDate.setHours(0,0,0,0);
  return Math.floor(ms / (1000*60*60*24));
}

/* ===== Processing ===== */
function processData(master, daily){
  console.log("Processing data...");
  console.log("Master records:", master.length);
  console.log("Daily records:", daily.length);
  
  const mMap = {}, dMap = {}; 
  master.forEach(r => mMap[makeKey(r)] = r); 
  daily.forEach(r => dMap[makeKey(r)] = r);
  
  const summary = {}, collected = [], notcollected = [], pivot = {};
  const overdue180 = [];
  const overdue180_195 = [];
  // New structures for monthly pivots and year-wise lists
  const monthlyPivot = { 2024: {}, 2025: {} }; // {year: {branch: {1..12: count}}}
  const yearNotCollectedList = { 2024: [], 2025: [] }; // detailed rows
  
  for(const [key, mRow] of Object.entries(mMap)){
    const branch = mRow.branch || "UNKNOWN";
    const year = getYear(mRow.sale_date);
    const month = getMonth(mRow.sale_date);
    
    // Initialize branch summary
    if(!summary[branch]) {
      summary[branch] = {collectible: 0, collected: 0, collectedAmount: 0};
    }
    
    // All master records are collectible
    summary[branch].collectible++;

    const dRow = dMap[key];
    const dailyCredit = toNumberSafe(dRow ? dRow.credit : 0);
    const dailyClosing = toNumberSafe(dRow ? dRow.closing : 0);
    
    // Collection logic: account is considered Collected if Daily file's Credit > 0
    if(dRow && dailyCredit > 0) { 
      summary[branch].collected++; 
      summary[branch].collectedAmount += dailyCredit; 
      collected.push({
        ...mRow, 
        credit: dailyCredit, 
        year: year,
        month: month,
        dailyOverdue: toNumberSafe(dRow.overdue || 0)
      });
    } else { 
      const notRow = {
        ...mRow, 
        credit: dRow ? dailyCredit : "(missing)", 
        year: year,
        month: month,
        dailyOverdue: dRow ? toNumberSafe(dRow.overdue || 0) : "(missing)",
        closing: dRow ? dailyClosing : 0
      };
      notcollected.push(notRow); 
      
      // Build pivot table: Branch-Year for Not Collected qty
      if(!pivot[branch]) pivot[branch] = {};
      pivot[branch][year] = (pivot[branch][year] || 0) + 1; 
      
      // Build monthly pivot for 2024 and 2025 only
      if(year === 2024 || year === 2025){
        const yearKey = year;
        if(!monthlyPivot[yearKey][branch]) monthlyPivot[yearKey][branch] = {};
        if(typeof month === "number"){
          monthlyPivot[yearKey][branch][month] = (monthlyPivot[yearKey][branch][month] || 0) + 1;
        } else {
          // treat unknown month as 0 key
          monthlyPivot[yearKey][branch][0] = (monthlyPivot[yearKey][branch][0] || 0) + 1;
        }
        yearNotCollectedList[yearKey].push(notRow);
      }

      // Build 180+ days overdue list (Sale_Date >= 180 days ago and Closing > 0)
      const saleDate = excelValueToDate(mRow.sale_date);
      const today = new Date();
      const ageDays = saleDate ? daysBetween(saleDate, today) : 0;
      const monthsOld = saleDate ? monthsBetween(saleDate, today) : 0;
      if(ageDays >= 180 && dailyClosing > 0){
        overdue180.push({
          branch: mRow.branch || "UNKNOWN",
          account: mRow.account || "",
          customer: mRow.customer || "",
          sale_date: saleDate ? saleDate.toISOString().slice(0,10) : (mRow.sale_date || ""),
          months_old: monthsOld,
          days_old: ageDays,
          closing: dailyClosing
        });
      }
      if(ageDays >= 180 && ageDays <= 195 && dailyClosing > 0){
        overdue180_195.push({
          branch: mRow.branch || "UNKNOWN",
          account: mRow.account || "",
          customer: mRow.customer || "",
          sale_date: saleDate ? saleDate.toISOString().slice(0,10) : (mRow.sale_date || ""),
          months_old: monthsOld,
          days_old: ageDays,
          closing: dailyClosing
        });
      }
    }
  }
  
  console.log("Processing complete:");
  console.log("Summary:", summary);
  console.log("Collected:", collected.length);
  console.log("Not collected:", notcollected.length);
  
  return {summary, collected, notcollected, pivot, monthlyPivot, yearNotCollectedList, overdue180, overdue180_195};
}

/* ===== Rendering ===== */
function renderSummary(summary, filteredData = null){
  const data = filteredData || summary;
  
  // Calculate percentages and identify lowest 10
  const branchPercs = [];
  for(const [b,v] of Object.entries(data)){
    const perc = v.collectible ? ((v.collected/v.collectible)*100) : 0;
    branchPercs.push({branch: b, perc: perc});
  }
  branchPercs.sort((a, b) => a.perc - b.perc);
  const lowest10Branches = new Set(branchPercs.slice(0, Math.min(10, branchPercs.length)).map(x => x.branch));
  
  let html="<table><tr><th>Branch</th><th>Collectible</th><th>Collected</th><th>Not Collected</th><th>Coll %</th><th>Total Amount Collected</th></tr>";
  let tCollectible=0, tCollected=0, tNotCollected=0, tAmount=0;
  for(const [b,v] of Object.entries(data)){
    const notCollected = v.collectible - v.collected;
    const perc=(v.collectible?((v.collected/v.collectible)*100).toFixed(2):"0");
    const isLowest10 = lowest10Branches.has(b);
    const rowStyle = isLowest10 ? 'style="background-color:#ffebee; border-left: 4px solid #d32f2f;"' : '';
    html+=`<tr ${rowStyle}><td>${b}</td><td>${v.collectible.toLocaleString()}</td><td>${v.collected.toLocaleString()}</td><td>${notCollected.toLocaleString()}</td><td style="${isLowest10 ? 'font-weight: 800; color: #c62828;' : ''}">${perc}%</td><td>${v.collectedAmount.toLocaleString()}</td></tr>`;
    tCollectible += v.collectible;
    tCollected += v.collected;
    tNotCollected += notCollected;
    tAmount += v.collectedAmount;
  }
  const tPerc = tCollectible ? ((tCollected/tCollectible)*100).toFixed(2) : "0";
  html+=`<tr style=\"background:#f0f0f0;font-weight:bold;\"><td>TOTAL</td><td>${tCollectible.toLocaleString()}</td><td>${tCollected.toLocaleString()}</td><td>${tNotCollected.toLocaleString()}</td><td>${tPerc}%</td><td>${tAmount.toLocaleString()}</td></tr>`;
  document.getElementById("summary").innerHTML=html+"</table>";
}
function renderPivot(pivot){
  if(!pivot||Object.keys(pivot).length===0){document.getElementById("pivot").innerHTML="<p>No data to display</p>";return;}
  const years=new Set(); for(const b in pivot){for(const y in pivot[b]) years.add(y);} const ya=[...years].sort();
  let html="<table><tr><th>Branch</th>"+ya.map(y=>`<th>${y} (Not Collected)</th>`).join("")+"<th>Total</th></tr>";
  const colTotals = new Array(ya.length).fill(0);
  let grandTotal = 0;
  for(const [b,ym] of Object.entries(pivot)){
    let rowTotal = 0;
    const cols = ya.map((y, idx)=>{ const v = ym[y]||0; colTotals[idx]+=v; rowTotal+=v; return `<td style=\"text-align:center;\">${v}</td>`; });
    grandTotal += rowTotal;
    html+=`<tr><td>${b}</td>${cols.join("")}<td style=\"text-align:center;font-weight:bold;\">${rowTotal}</td></tr>`;
  }
  html+=`<tr style=\"background:#e0e0e0;font-weight:bold;\"><td>TOTAL</td>${colTotals.map(v=>`<td style=\"text-align:center;\">${v}</td>`).join("")}<td style=\"text-align:center;\">${grandTotal}</td></tr>`;
  document.getElementById("pivot").innerHTML=html+"</table>";
}

function renderMonthlyPivot(year, monthlyMap, containerId){
  const container = document.getElementById(containerId);
  if(!monthlyMap || Object.keys(monthlyMap).length === 0){
    container.innerHTML = "<p style='color:#666;font-style:italic;'>No not collected items found for "+year+".</p>";
    return;
  }
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; // 1..12
  let html = `<table>
    <tr>
      <th>Branch</th>
      ${months.map(m=>`<th>${m}</th>`).join("")}
      <th><strong>Total</strong></th>
    </tr>`;
  const branches = Object.keys(monthlyMap).sort();
  const monthTotals = new Array(12).fill(0);
  let grandTotal = 0;
  for(const branch of branches){
    const counts = monthlyMap[branch] || {};
    let rowTotal = 0;
    html += `<tr><td><strong>${branch}</strong></td>`;
    for(let m=1;m<=12;m++){
      const val = counts[m] || 0;
      rowTotal += val;
      monthTotals[m-1] += val;
      html += `<td style="text-align:center;">${val}</td>`;
    }
    grandTotal += rowTotal;
    html += `<td style="text-align:center;font-weight:bold;background:#f0f0f0;">${rowTotal}</td></tr>`;
  }
  html += `<tr style="background:#e0e0e0;font-weight:bold;">
    <td>TOTAL</td>
    ${monthTotals.map(v=>`<td style="text-align:center;">${v}</td>`).join("")}
    <td style="text-align:center;background:#d0d0d0;">${grandTotal}</td>
  </tr>`;
  html += `</table>`;
  container.innerHTML = html;
}

function renderStats(data){
  const {summary, collected, notcollected} = data;
  const totalCollectible = Object.values(summary).reduce((sum, s) => sum + s.collectible, 0);
  const totalCollected = Object.values(summary).reduce((sum, s) => sum + s.collected, 0);
  const totalAmount = Object.values(summary).reduce((sum, s) => sum + s.collectedAmount, 0);
  const collectionRate = totalCollectible > 0 ? ((totalCollected / totalCollectible) * 100).toFixed(1) : 0;
  
  const statsHtml = `
    <div class="stat-card">
      <div class="stat-number">${totalCollectible.toLocaleString()}</div>
      <div class="stat-label">Total Collectible</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${totalCollected.toLocaleString()}</div>
      <div class="stat-label">Total Collected</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${collectionRate}%</div>
      <div class="stat-label">Collection Rate</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">‚Çπ${totalAmount.toLocaleString()}</div>
      <div class="stat-label">Total Amount</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${collected.length}</div>
      <div class="stat-label">Collected Items</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${notcollected.length}</div>
      <div class="stat-label">Not Collected Items</div>
    </div>
  `;
  
  document.getElementById("statsGrid").innerHTML = statsHtml;
}

function groupAndRenderSummary(list, containerId){
  const container = document.getElementById(containerId);
  if(!container) return;
  if(!list || list.length === 0){
    container.innerHTML = "<p style='color:#7a4a00;font-style:italic;'>No matching accounts.</p>";
    return;
  }
  const byBranch = {};
  list.forEach(r => {
    const b = r.branch || "UNKNOWN";
    if(!byBranch[b]) byBranch[b] = { count: 0, amount: 0 };
    byBranch[b].count += 1;
    byBranch[b].amount += Number(r.closing)||0;
  });
  let tCount = 0, tAmt = 0;
  let html = "<table><tr><th>Branch</th><th>Accounts</th><th>Total Balance</th></tr>";
  Object.keys(byBranch).sort().forEach(b => {
    const v = byBranch[b];
    tCount += v.count; tAmt += v.amount;
    html += `<tr><td>${sanitizeInput(b)}</td><td style="text-align:right;">${v.count}</td><td style="text-align:right;">${v.amount.toLocaleString()}</td></tr>`;
  });
  html += `<tr style=\"background:#f0e6d6;font-weight:bold;\"><td>TOTAL</td><td style=\"text-align:right;\">${tCount}</td><td style=\"text-align:right;\">${tAmt.toLocaleString()}</td></tr>`;
  html += "</table>";
  container.innerHTML = html;
}

function renderOverdue180Summary(list){
  groupAndRenderSummary(list, "overdue180Summary");
}

function renderOverdue180_195Summary(list){
  groupAndRenderSummary(list, "overdue180_195Summary");
}

function renderOverdue180ByYear(list){
  const container = document.getElementById("overdue180ByYear");
  if(!container) return;
  if(!list || list.length === 0){ container.innerHTML = ""; return; }
  // Build set of years and branch-year counts
  const yearsSet = new Set();
  const map = {}; // branch -> year -> count
  list.forEach(r => {
    const y = (r.sale_date && r.sale_date.length>=4) ? new Date(r.sale_date).getFullYear() : "Unknown";
    yearsSet.add(y);
    const b = r.branch || "UNKNOWN";
    if(!map[b]) map[b] = {};
    map[b][y] = (map[b][y]||0) + 1;
  });
  const years = Array.from(yearsSet).sort();
  let html = "<table><tr><th>Branch</th>" + years.map(y=>`<th>${y}</th>`).join("") + "<th>Total</th></tr>";
  let colTotals = years.map(()=>0);
  let grand = 0;
  Object.keys(map).sort().forEach(b => {
    let row = `<tr><td>${sanitizeInput(b)}</td>`;
    let rtot = 0;
    years.forEach((y, idx) => {
      const v = map[b][y] || 0;
      rtot += v; grand += v; colTotals[idx] += v;
      row += `<td style=\"text-align:center;\">${v}</td>`;
    });
    row += `<td style=\"text-align:center;font-weight:bold;\">${rtot}</td></tr>`;
    html += row;
  });
  html += `<tr style=\"background:#f0e6d6;font-weight:bold;\"><td>TOTAL</td>` +
          years.map((_,i)=>`<td style=\"text-align:center;\">${colTotals[i]}</td>`).join("") +
          `<td style=\"text-align:center;\">${grand}</td></tr>`;
  html += "</table>";
  container.innerHTML = html;
}

/* ===== Filtering Functions ===== */
function filterSummary() {
  if (!window._exportData) return;
  
  const searchTerm = document.getElementById("branchSearch").value.toLowerCase();
  const sortBy = document.getElementById("sortBy").value;
  const summary = window._exportData.summary;
  
  let filtered = Object.entries(summary).filter(([branch, data]) => 
    branch.toLowerCase().includes(searchTerm)
  );
  
  // Sort the filtered data
  filtered.sort((a, b) => {
    const [branchA, dataA] = a;
    const [branchB, dataB] = b;
    
    switch(sortBy) {
      case 'branch':
        return branchA.localeCompare(branchB);
      case 'collectible':
        return dataB.collectible - dataA.collectible;
      case 'collected':
        return dataB.collected - dataA.collected;
      case 'percentage':
        const percA = dataA.collectible > 0 ? (dataA.collected / dataA.collectible) : 0;
        const percB = dataB.collectible > 0 ? (dataB.collected / dataB.collectible) : 0;
        return percB - percA;
      case 'amount':
        return dataB.collectedAmount - dataA.collectedAmount;
      default:
        return 0;
    }
  });
  
  const filteredSummary = Object.fromEntries(filtered);
  renderSummary(summary, filteredSummary);
}

function filterPivot() {
  if (!window._exportData) return;
  
  const searchTerm = document.getElementById("pivotSearch").value.toLowerCase();
  const yearFilterEl = document.getElementById("yearFilter");
  const selectedYears = Array.from(yearFilterEl.selectedOptions).map(opt => opt.value).filter(v => v !== "");
  const pivot = window._exportData.pivot;
  
  if (!pivot || Object.keys(pivot).length === 0) {
    document.getElementById("pivot").innerHTML = "<p>No data to display</p>";
    return;
  }
  
  const years = new Set();
  for (const b in pivot) {
    for (const y in pivot[b]) years.add(y);
  }
  const ya = [...years].sort();
  
  // Update year filter options
  updateYearFilter(ya);
  
  let filteredPivot = {};
  for (const [branch, yearData] of Object.entries(pivot)) {
    if (branch.toLowerCase().includes(searchTerm)) {
      if (selectedYears.length > 0) {
        // Filter to show only selected years
        const filteredYearData = {};
        selectedYears.forEach(year => {
          if (yearData[year] !== undefined) {
            filteredYearData[year] = yearData[year];
          }
        });
        if (Object.keys(filteredYearData).length > 0) {
          filteredPivot[branch] = filteredYearData;
        }
      } else {
        filteredPivot[branch] = yearData;
      }
    }
  }
  
  // Store filtered pivot for screenshot
  window._filteredPivot = filteredPivot;
  
  renderPivot(filteredPivot);
}

function updateYearFilter(years) {
  const yearFilter = document.getElementById("yearFilter");
  const currentValue = yearFilter.value;
  
  yearFilter.innerHTML = '<option value="">All Years</option>';
  years.forEach(year => {
    const option = document.createElement("option");
    option.value = year;
    option.textContent = year;
    if (year === currentValue) option.selected = true;
    yearFilter.appendChild(option);
  });
}

function resetFilters() {
  document.getElementById("branchSearch").value = "";
  document.getElementById("sortBy").value = "branch";
  document.getElementById("pivotSearch").value = "";
  document.getElementById("yearFilter").value = "";
  
  if (window._exportData) {
    renderSummary(window._exportData.summary);
    renderPivot(window._exportData.pivot);
  }
}

/* ===== Help Functions ===== */
function showHelp() {
  document.getElementById("helpModal").style.display = "block";
}

function hideHelp() {
  document.getElementById("helpModal").style.display = "none";
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById("helpModal");
  if (event.target === modal) {
    modal.style.display = "none";
  }
}

/* ===== Buttons ===== */
async function processFiles(){
  // Allow using local master to bypass Drive
  const useLocal = document.getElementById("useLocalMaster").checked;
  const daily=document.getElementById("dailyFile").files[0]; 
  if(!daily) return showStatus("Please select a daily file to process","error");
  
  // Show loading state
  showLoading("processLoading", "processText", "Processing...");
  showProgress("processProgress", "processProgressFill", 0);
  
  try {
    updateProgress("processProgressFill", 15);
    let master;
    if(useLocal){
      const localMasterFile = document.getElementById("localMasterFile").files[0];
      if(!localMasterFile){
        throw new Error("Please select a local master file or uncheck 'Use local master'.");
      }
      showStatus("Reading local master...","info");
      const masterBuffer = await new Promise((res, rej) => { const fr = new FileReader(); fr.onload = e => res(e.target.result); fr.onerror = rej; fr.readAsArrayBuffer(localMasterFile); });
      master = parseWorkbook(masterBuffer);
    } else {
      if(!masterFileId) throw new Error("No master file found in Drive. Upload one or use local master.");
      showStatus("Downloading master from Drive...","info");
      const masterBuffer = await downloadMasterFile();
      master = parseWorkbook(masterBuffer);
    }
    
    updateProgress("processProgressFill", 60);
    showStatus("Reading daily file...","info");
    const dailyData = await readLocalFile(daily);
    
    updateProgress("processProgressFill", 80);
    const res = processData(master, dailyData);
    
    renderSummary(res.summary);
    renderPivot(res.pivot);
    renderMonthlyPivot(2024, res.monthlyPivot[2024], "pivot2024Monthly");
    renderMonthlyPivot(2025, res.monthlyPivot[2025], "pivot2025Monthly");
    renderStats(res);
    renderOverdue180Summary(res.overdue180);
    renderOverdue180ByYear(res.overdue180);
    renderOverdue180_195Summary(res.overdue180_195);
    
  // Show results sections
    document.getElementById("statsSection").style.display = "block";
    document.getElementById("resultsSection").style.display = "block";
    document.getElementById("overdue180Section").style.display = res.overdue180 && res.overdue180.length? "block" : "none";
    document.getElementById("overdue180_195Section").style.display = res.overdue180_195 && res.overdue180_195.length? "block" : "none";
    
    window._exportData = res;
    
  // Enable download & screenshot buttons
    document.getElementById("downloadBtn").disabled = false;
    document.getElementById("downloadOverdue180Btn").disabled = !(res.overdue180 && res.overdue180.length);
    document.getElementById("downloadOverdue180_195Btn").disabled = !(res.overdue180_195 && res.overdue180_195.length);
    document.getElementById("shotBranchSummary").disabled = !(res.summary && Object.keys(res.summary).length);
    document.getElementById("shotBranchYear").disabled = !(res.pivot && Object.keys(res.pivot).length);
    const has2024 = res.yearNotCollectedList[2024].length > 0;
    const has2025 = res.yearNotCollectedList[2025].length > 0;
    document.getElementById("download2024MonthlyBtn").disabled = !has2024;
    document.getElementById("download2025MonthlyBtn").disabled = !has2025;
    document.getElementById("shot2024").disabled = !has2024;
    document.getElementById("shot2025").disabled = !has2025;
    
    updateProgress("processProgressFill", 100);
    showStatus("Processing completed successfully!", "success");
  } catch (error) {
    showStatus("Processing failed: " + error.message,"error");
    console.error("Processing error:", error);
  } finally {
    hideLoading("processLoading", "processText", "Process Comparison");
    setTimeout(() => hideProgress("processProgress"), 2000);
  }
}

// Screenshot helpers
function downloadCanvasAsImage(canvas, filename){
  canvas.toBlob(function(blob){
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
  });
}

function getThemeStyles(theme) {
  if (theme === 'light') {
    return {
      bgColor: '#ffffff',
      containerBg: '#ffffff',
      borderColor: '#4CAF50',
      titleColor: '#000000',
      titleShadow: 'none',
      dateColor: '#333333',
      filterInfoColor: '#000000',
      filterInfoBg: 'rgba(76, 175, 80, 0.1)',
      tableBg: '#ffffff',
      thBg: '#4CAF50',
      thColor: '#ffffff',
      thBorder: '#2e7d32',
      tdBg: '#ffffff',
      tdColor: '#000000',
      tdBorder: '#ddd',
      evenRowBg: '#f5f5f5',
      totalRowBg: '#e8f5e9',
      totalRowColor: '#000000',
      // Red highlighting for lowest performers
      redRowBg: '#d32f2f',
      redRowBorder: '#b71c1c',
      redCellColor: '#ffffff',
      redPercentColor: '#ffeb3b'
    };
  } else {
    return {
      bgColor: '#0d4d4d',
      containerBg: '#0d4d4d',
      borderColor: '#00bcd4',
      titleColor: '#ffffff',
      titleShadow: '2px 2px 4px rgba(0,0,0,0.3)',
      dateColor: '#e0f7fa',
      filterInfoColor: '#ffeb3b',
      filterInfoBg: 'rgba(0, 188, 212, 0.2)',
      tableBg: '#0d4d4d',
      thBg: '#00838f',
      thColor: '#ffffff',
      thBorder: '#006064',
      tdBg: '#0d4d4d',
      tdColor: '#ffffff',
      tdBorder: '#006064',
      evenRowBg: '#115555',
      totalRowBg: '#00695c',
      totalRowColor: '#ffffff',
      // Red highlighting for lowest performers
      redRowBg: '#b71c1c',
      redRowBorder: '#d32f2f',
      redCellColor: '#ffffff',
      redPercentColor: '#ffeb3b'
    };
  }
}

document.getElementById("shot2024").addEventListener("click", async ()=>{
  const tableEl = document.getElementById("pivot2024Monthly");
  if(!tableEl || tableEl.innerHTML.trim()==="") return showStatus("Nothing to capture for 2024.","error");
  
  // Get selected theme
  const theme = document.getElementById("theme2024").value;
  const themeStyles = getThemeStyles(theme);
  
  // Create a temporary container with header
  const tempContainer = document.createElement('div');
  tempContainer.style.cssText = `position: absolute; left: -9999px; background: ${themeStyles.containerBg}; padding: 40px; font-family: Inter, sans-serif; width: 1400px;`;
  
  // Create header
  const header = document.createElement('div');
  header.style.cssText = `text-align: center; margin-bottom: 30px; border-bottom: 4px solid ${themeStyles.borderColor}; padding-bottom: 20px;`;
  
  const title = document.createElement('h2');
  title.textContent = '2024 No Coll AC';
  title.style.cssText = `margin: 0 0 12px 0; font-size: 36px; font-weight: 800; color: ${themeStyles.titleColor}; letter-spacing: 0.5px; text-shadow: ${themeStyles.titleShadow};`;
  
  const datetime = document.createElement('div');
  const now = new Date();
  datetime.textContent = now.toLocaleString('en-US', { 
    year: 'numeric', month: 'long', day: 'numeric', 
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
  });
  datetime.style.cssText = `font-size: 18px; font-weight: 700; color: ${themeStyles.dateColor};`;
  
  header.appendChild(title);
  header.appendChild(datetime);
  
  // Clone only the table
  const tableClone = tableEl.cloneNode(true);
  
  // Apply bold styling to table for better readability
  const style = document.createElement('style');
  style.textContent = `
    table { border-collapse: collapse; width: 100%; font-size: 15px; background: ${themeStyles.tableBg}; }
    th { background: ${themeStyles.thBg} !important; color: ${themeStyles.thColor} !important; padding: 16px !important; 
         font-weight: 800 !important; font-size: 16px !important; border: 2px solid ${themeStyles.thBorder} !important; 
         text-align: center !important; letter-spacing: 0.3px !important; }
    td { padding: 14px !important; border: 2px solid ${themeStyles.tdBorder} !important; font-weight: 800 !important; 
         color: ${themeStyles.tdColor} !important; font-size: 15px !important; text-align: center !important; background: ${themeStyles.tdBg} !important; }
    td:first-child { text-align: left !important; font-weight: 900 !important; }
    tr:nth-child(even) td { background-color: ${themeStyles.evenRowBg} !important; }
    tr[style*="font-weight:bold"] td, 
    td[style*="font-weight:bold"] { 
      font-weight: 900 !important; 
      background: ${themeStyles.totalRowBg} !important; 
      color: ${themeStyles.totalRowColor} !important;
    }
  `;
  
  // Assemble temp container
  tempContainer.appendChild(style);
  tempContainer.appendChild(header);
  tempContainer.appendChild(tableClone);
  document.body.appendChild(tempContainer);
  
  // Capture screenshot with higher quality settings
  const canvas = await html2canvas(tempContainer, {
    backgroundColor: themeStyles.bgColor, 
    scale: 3,
    logging: false,
    useCORS: true,
    allowTaint: true,
    imageTimeout: 0
  });
  
  // Clean up
  document.body.removeChild(tempContainer);
  
  const ts = new Date().toISOString().slice(0,19).replace(/:/g,'-');
  const themeName = theme === 'light' ? 'Light' : 'Dark';
  downloadCanvasAsImage(canvas, `2024_No_Coll_AC_${themeName}_${ts}.png`);
});

document.getElementById("shot2025").addEventListener("click", async ()=>{
  const tableEl = document.getElementById("pivot2025Monthly");
  if(!tableEl || tableEl.innerHTML.trim()==="") return showStatus("Nothing to capture for 2025.","error");
  
  // Get selected theme
  const theme = document.getElementById("theme2025").value;
  const themeStyles = getThemeStyles(theme);
  
  // Create a temporary container with header
  const tempContainer = document.createElement('div');
  tempContainer.style.cssText = `position: absolute; left: -9999px; background: ${themeStyles.containerBg}; padding: 40px; font-family: Inter, sans-serif; width: 1400px;`;
  
  // Create header
  const header = document.createElement('div');
  header.style.cssText = `text-align: center; margin-bottom: 30px; border-bottom: 4px solid ${themeStyles.borderColor}; padding-bottom: 20px;`;
  
  const title = document.createElement('h2');
  title.textContent = '2025 No Coll AC';
  title.style.cssText = `margin: 0 0 12px 0; font-size: 36px; font-weight: 800; color: ${themeStyles.titleColor}; letter-spacing: 0.5px; text-shadow: ${themeStyles.titleShadow};`;
  
  const datetime = document.createElement('div');
  const now = new Date();
  datetime.textContent = now.toLocaleString('en-US', { 
    year: 'numeric', month: 'long', day: 'numeric', 
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
  });
  datetime.style.cssText = `font-size: 18px; font-weight: 700; color: ${themeStyles.dateColor};`;
  
  header.appendChild(title);
  header.appendChild(datetime);
  
  // Clone only the table
  const tableClone = tableEl.cloneNode(true);
  
  // Apply bold styling to table for better readability
  const style = document.createElement('style');
  style.textContent = `
    table { border-collapse: collapse; width: 100%; font-size: 15px; background: ${themeStyles.tableBg}; }
    th { background: ${themeStyles.thBg} !important; color: ${themeStyles.thColor} !important; padding: 16px !important; 
         font-weight: 800 !important; font-size: 16px !important; border: 2px solid ${themeStyles.thBorder} !important; 
         text-align: center !important; letter-spacing: 0.3px !important; }
    td { padding: 14px !important; border: 2px solid ${themeStyles.tdBorder} !important; font-weight: 800 !important; 
         color: ${themeStyles.tdColor} !important; font-size: 15px !important; text-align: center !important; background: ${themeStyles.tdBg} !important; }
    td:first-child { text-align: left !important; font-weight: 900 !important; }
    tr:nth-child(even) td { background-color: ${themeStyles.evenRowBg} !important; }
    tr[style*="font-weight:bold"] td, 
    td[style*="font-weight:bold"] { 
      font-weight: 900 !important; 
      background: ${themeStyles.totalRowBg} !important; 
      color: ${themeStyles.totalRowColor} !important;
    }
  `;
  
  // Assemble temp container
  tempContainer.appendChild(style);
  tempContainer.appendChild(header);
  tempContainer.appendChild(tableClone);
  document.body.appendChild(tempContainer);
  
  // Capture screenshot with higher quality settings
  const canvas = await html2canvas(tempContainer, {
    backgroundColor: themeStyles.bgColor, 
    scale: 3,
    logging: false,
    useCORS: true,
    allowTaint: true,
    imageTimeout: 0
  });
  
  // Clean up
  document.body.removeChild(tempContainer);
  
  const ts = new Date().toISOString().slice(0,19).replace(/:/g,'-');
  const themeName = theme === 'light' ? 'Light' : 'Dark';
  downloadCanvasAsImage(canvas, `2025_No_Coll_AC_${themeName}_${ts}.png`);
});

// Screenshot for Branch-Year pivot
document.getElementById("shotBranchYear").addEventListener("click", async ()=>{
  const tableEl = document.getElementById("pivot");
  if(!tableEl || tableEl.innerHTML.trim()==="") return showStatus("Nothing to capture for Branch-Year.","error");
  
  // Get selected theme
  const theme = document.getElementById("themeBranchYear").value;
  const themeStyles = getThemeStyles(theme);
  
  // Create a temporary container with header
  const tempContainer = document.createElement('div');
  tempContainer.style.cssText = `position: absolute; left: -9999px; background: ${themeStyles.containerBg}; padding: 40px; font-family: Inter, sans-serif; width: 1400px;`;
  
  // Create header
  const header = document.createElement('div');
  header.style.cssText = `text-align: center; margin-bottom: 30px; border-bottom: 4px solid ${themeStyles.borderColor}; padding-bottom: 20px;`;
  
  const title = document.createElement('h2');
  title.textContent = 'Branch-Year Not Collected';
  title.style.cssText = `margin: 0 0 12px 0; font-size: 36px; font-weight: 800; color: ${themeStyles.titleColor}; letter-spacing: 0.5px; text-shadow: ${themeStyles.titleShadow};`;
  
  const datetime = document.createElement('div');
  const now = new Date();
  datetime.textContent = now.toLocaleString('en-US', { 
    year: 'numeric', month: 'long', day: 'numeric', 
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
  });
  datetime.style.cssText = `font-size: 18px; font-weight: 700; color: ${themeStyles.dateColor};`;
  
  header.appendChild(title);
  header.appendChild(datetime);
  
  // Add filter info if years are selected
  const yearFilterEl = document.getElementById("yearFilter");
  const selectedYears = Array.from(yearFilterEl.selectedOptions).map(opt => opt.value).filter(v => v !== "");
  if (selectedYears.length > 0) {
    const filterInfo = document.createElement('div');
    filterInfo.textContent = 'Filtered Years: ' + selectedYears.join(', ');
    filterInfo.style.cssText = `font-size: 16px; font-weight: 600; color: ${themeStyles.filterInfoColor}; margin-top: 10px; background: ${themeStyles.filterInfoBg}; padding: 8px; border-radius: 6px;`;
    header.appendChild(filterInfo);
  }
  
  // Clone only the table
  const tableClone = tableEl.cloneNode(true);
  
  // Apply bold styling to table for better readability
  const style = document.createElement('style');
  style.textContent = `
    table { border-collapse: collapse; width: 100%; font-size: 15px; background: ${themeStyles.tableBg}; }
    th { background: ${themeStyles.thBg} !important; color: ${themeStyles.thColor} !important; padding: 16px !important; 
         font-weight: 800 !important; font-size: 16px !important; border: 2px solid ${themeStyles.thBorder} !important; 
         text-align: center !important; letter-spacing: 0.3px !important; }
    td { padding: 14px !important; border: 2px solid ${themeStyles.tdBorder} !important; font-weight: 800 !important; 
         color: ${themeStyles.tdColor} !important; font-size: 15px !important; text-align: center !important; background: ${themeStyles.tdBg} !important; }
    td:first-child { text-align: left !important; font-weight: 900 !important; }
    tr:nth-child(even) td { background-color: ${themeStyles.evenRowBg} !important; }
    tr[style*="font-weight:bold"] td, 
    td[style*="font-weight:bold"] { 
      font-weight: 900 !important; 
      background: ${themeStyles.totalRowBg} !important; 
      color: ${themeStyles.totalRowColor} !important;
    }
  `;
  
  // Assemble temp container
  tempContainer.appendChild(style);
  tempContainer.appendChild(header);
  tempContainer.appendChild(tableClone);
  document.body.appendChild(tempContainer);
  
  // Capture screenshot with higher quality settings
  const canvas = await html2canvas(tempContainer, {
    backgroundColor: themeStyles.bgColor, 
    scale: 3,
    logging: false,
    useCORS: true,
    allowTaint: true,
    imageTimeout: 0
  });
  
  // Clean up
  document.body.removeChild(tempContainer);
  
  const ts = new Date().toISOString().slice(0,19).replace(/:/g,'-');
  const themeName = theme === 'light' ? 'Light' : 'Dark';
  downloadCanvasAsImage(canvas, `Branch_Year_Not_Collected_${themeName}_${ts}.png`);
});

// Screenshot for Branch Summary
document.getElementById("shotBranchSummary").addEventListener("click", async ()=>{
  const tableEl = document.getElementById("summary");
  if(!tableEl || tableEl.innerHTML.trim()==="") return showStatus("Nothing to capture for Branch Summary.","error");
  
  // Get selected theme
  const theme = document.getElementById("themeBranchSummary").value;
  const themeStyles = getThemeStyles(theme);
  
  // Create a temporary container with header
  const tempContainer = document.createElement('div');
  tempContainer.style.cssText = `position: absolute; left: -9999px; background: ${themeStyles.containerBg}; padding: 40px; font-family: Inter, sans-serif; width: 1200px;`;
  
  // Create header
  const header = document.createElement('div');
  header.style.cssText = `text-align: center; margin-bottom: 30px; border-bottom: 4px solid ${themeStyles.borderColor}; padding-bottom: 20px;`;
  
  const title = document.createElement('h2');
  title.textContent = 'Card Collection Report';
  title.style.cssText = `margin: 0 0 12px 0; font-size: 36px; font-weight: 800; color: ${themeStyles.titleColor}; letter-spacing: 0.5px; text-shadow: ${themeStyles.titleShadow};`;
  
  const datetime = document.createElement('div');
  const now = new Date();
  datetime.textContent = now.toLocaleString('en-US', { 
    year: 'numeric', month: 'long', day: 'numeric', 
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true 
  });
  datetime.style.cssText = `font-size: 18px; font-weight: 700; color: ${themeStyles.dateColor};`;
  
  header.appendChild(title);
  header.appendChild(datetime);
  
  // Clone only the table, not the entire section (to exclude filter controls)
  const tableClone = tableEl.cloneNode(true);
  
  // Manually apply red styling to lowest performer rows in the clone
  const rows = tableClone.querySelectorAll('tr');
  rows.forEach(row => {
    if (row.style.backgroundColor && row.style.backgroundColor.includes('ffebee')) {
      // Apply red background directly
      row.style.cssText = `background: ${themeStyles.redRowBg} !important; border-left: 8px solid #ff5252 !important; border-right: 3px solid #ff1744 !important;`;
      
      // Style all cells in this row
      const cells = row.querySelectorAll('td');
      cells.forEach((cell, index) => {
        cell.style.background = themeStyles.redRowBg;
        cell.style.color = themeStyles.redCellColor;
        cell.style.fontWeight = '900';
        cell.style.fontSize = '15px';
        cell.style.padding = '14px';
        cell.style.border = `2px solid ${themeStyles.redRowBorder}`;
        cell.style.textShadow = theme === 'light' ? 'none' : '1px 1px 2px rgba(0, 0, 0, 0.5)';
        
        // Check if this is the percentage column (usually has red color in original)
        if (cell.style.color && (cell.style.color.includes('c62828') || cell.style.color.includes('d32f2f'))) {
          cell.style.color = themeStyles.redPercentColor;
          cell.style.fontSize = '17px';
          cell.style.fontWeight = '900';
          cell.style.textShadow = theme === 'light' ? 'none' : '0 0 4px rgba(255, 235, 59, 0.8), 1px 1px 2px rgba(0, 0, 0, 0.5)';
          cell.style.background = themeStyles.redRowBorder;
          cell.style.borderRadius = '4px';
        }
      });
    }
  });
  
  // Apply bold styling to table for better readability
  const style = document.createElement('style');
  style.textContent = `
    table { border-collapse: collapse; width: 100%; font-size: 15px; background: ${themeStyles.tableBg}; }
    th { background: ${themeStyles.thBg} !important; color: ${themeStyles.thColor} !important; padding: 16px !important; 
         font-weight: 800 !important; font-size: 16px !important; border: 2px solid ${themeStyles.thBorder} !important; 
         text-align: left !important; letter-spacing: 0.3px !important; }
    td { padding: 14px !important; border: 2px solid ${themeStyles.tdBorder} !important; font-weight: 800 !important; 
         color: ${themeStyles.tdColor} !important; font-size: 15px !important; background: ${themeStyles.tdBg} !important; }
    tr:nth-child(even) td { background-color: ${themeStyles.evenRowBg} !important; }
    tr[style*="font-weight:bold"] td { font-weight: 900 !important; background: ${themeStyles.totalRowBg} !important; color: ${themeStyles.totalRowColor} !important; }
    td[style*="text-align:right"], td[style*="text-align:center"] { font-weight: 800 !important; }
  `;
  
  // Assemble temp container
  tempContainer.appendChild(style);
  tempContainer.appendChild(header);
  tempContainer.appendChild(tableClone);
  document.body.appendChild(tempContainer);
  
  // Capture screenshot with higher quality settings
  const canvas = await html2canvas(tempContainer, {
    backgroundColor: themeStyles.bgColor,
    scale: 3,  // Increased scale for sharper image
    logging: false,
    useCORS: true,
    allowTaint: true,
    imageTimeout: 0
  });
  
  // Clean up
  document.body.removeChild(tempContainer);
  
  const ts = new Date().toISOString().slice(0,19).replace(/:/g,'-');
  const themeName = theme === 'light' ? 'Light' : 'Dark';
  downloadCanvasAsImage(canvas, `Branch_Summary_${themeName}_${ts}.png`);
});

function downloadExcel(){
  if(!window._exportData) {
    showStatus("No data to export. Please process files first.","error");
    return;
  }
  
  const {summary,collected,notcollected,pivot,overdue180,overdue180_195}=window._exportData; 
  const wb=XLSX.utils.book_new();
  
  // Summary sheet with enhanced formatting
  const sArr=[["Branch","Collectible","Collected","Not Collected","Coll %","Total Amount Collected"]];
  for(const [b,v] of Object.entries(summary)){
    const notCollected = v.collectible - v.collected;
    const percentage = v.collectible > 0 ? (v.collected/v.collectible*100).toFixed(2) : 0;
    sArr.push([b,v.collectible,v.collected,notCollected,percentage,v.collectedAmount]);
  }
  
  // Add totals row
  const totalCollectible = Object.values(summary).reduce((sum, s) => sum + s.collectible, 0);
  const totalCollected = Object.values(summary).reduce((sum, s) => sum + s.collected, 0);
  const totalNotCollected = totalCollectible - totalCollected;
  const totalAmount = Object.values(summary).reduce((sum, s) => sum + s.collectedAmount, 0);
  const totalPercentage = totalCollectible > 0 ? (totalCollected/totalCollectible*100).toFixed(2) : 0;
  sArr.push(["TOTAL", totalCollectible, totalCollected, totalNotCollected, totalPercentage, totalAmount]);
  
  const summarySheet = XLSX.utils.aoa_to_sheet(sArr);
  XLSX.utils.book_append_sheet(wb, summarySheet, "Summary");

  // Collected items sheet
  const cArr=[["Branch","Account","Customer","Overdue","Credit","Year","Collection Date"]];
  collected.forEach(r=>cArr.push([r.branch,r.account,r.customer,r.overdue,r.credit,r.year,new Date().toLocaleDateString()]));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(cArr),"Collected");

  // Not collected items sheet
  const nArr=[["Branch","Account","Customer","Overdue","Credit","Year","Status"]];
  notcollected.forEach(r=>nArr.push([r.branch,r.account,r.customer,r.overdue,r.credit,r.year,"Not Collected"]));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(nArr),"NotCollected");

  // Pivot sheet
  const years=new Set(); 
  for(const b in pivot){for(const y in pivot[b]) years.add(y);} 
  const ya=[...years].sort(); 
  const pArr=[["Branch",...ya.map(y=>y+" (Not Collected)")]];
  for(const [b,ym] of Object.entries(pivot)) {
    const row = [b, ...ya.map(y=>ym[y]||0)];
    pArr.push(row);
  }
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(pArr),"Pivot");

  // Overdue 180+ sheet
  if(overdue180 && overdue180.length){
    const oArr = [["Branch","Account","Customer","Sale_Date","Collection Running Month","Days Old","Closing Balance"]];
    overdue180.forEach(r=>{
      oArr.push([r.branch, r.account, r.customer, r.sale_date, r.months_old, r.days_old || "", r.closing]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(oArr), "Overdue180Days");
  }

  // Overdue 180‚Äì195 sheet
  if(overdue180_195 && overdue180_195.length){
    const o2Arr = [["Branch","Account","Customer","Sale_Date","Collection Running Month","Days Old","Closing Balance"]];
    overdue180_195.forEach(r=>{
      o2Arr.push([r.branch, r.account, r.customer, r.sale_date, r.months_old, r.days_old, r.closing]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(o2Arr), "Overdue180_195Days");
  }

  // 2024 Monthly Not Collected Pivot
  if(window._exportData && window._exportData.monthlyPivot && window._exportData.monthlyPivot[2024]){
    const mp2024 = window._exportData.monthlyPivot[2024];
    const monthsHdr = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; 
    const arr2024 = [["Branch", ...monthsHdr, "Total"]];
    const branches2024 = Object.keys(mp2024).sort();
    branches2024.forEach(branch => {
      const counts = mp2024[branch]||{}; 
      const rowMonths = [];
      let total = 0;
      for(let m=1;m<=12;m++){ const v = counts[m]||0; rowMonths.push(v); total += v; }
      arr2024.push([branch, ...rowMonths, total]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(arr2024), "2024 Monthly Pivot");
  }

  // 2025 Monthly Not Collected Pivot
  if(window._exportData && window._exportData.monthlyPivot && window._exportData.monthlyPivot[2025]){
    const mp2025 = window._exportData.monthlyPivot[2025];
    const monthsHdr = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; 
    const arr2025 = [["Branch", ...monthsHdr, "Total"]];
    const branches2025 = Object.keys(mp2025).sort();
    branches2025.forEach(branch => {
      const counts = mp2025[branch]||{}; 
      const rowMonths = [];
      let total = 0;
      for(let m=1;m<=12;m++){ const v = counts[m]||0; rowMonths.push(v); total += v; }
      arr2025.push([branch, ...rowMonths, total]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(arr2025), "2025 Monthly Pivot");
  }

  // Generate filename with timestamp
  const timestamp = new Date().toISOString().slice(0,19).replace(/:/g, '-');
  const filename = `BranchComparison_${timestamp}.xlsx`;
  
  XLSX.writeFile(wb, filename);
  showStatus(`Excel file downloaded: ${filename}`,"success");
}

document.getElementById("download2024MonthlyBtn").addEventListener("click", ()=>{
  if(!window._exportData) return showStatus("No data to download.", "error");
  const list = window._exportData.yearNotCollectedList[2024] || [];
  if(list.length === 0) return showStatus("No 2024 data to download.", "error");
  const wb = XLSX.utils.book_new();
  
  // Sheet 1: Detailed list
  const header = ["Branch","Month","Account","Customer","Master Overdue","Daily Credit","Daily Overdue","Sale Year"];
  const aoa = [header];
  list.forEach(r=>{
    const monthName = ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][typeof r.month === "number"? r.month : 0] || "Unknown";
    aoa.push([r.branch, monthName, r.account, r.customer, r.overdue, r.credit, r.dailyOverdue, r.year]);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), "2024 Not Collected");
  
  // Sheet 2: Monthly pivot summary
  const mp2024 = (window._exportData.monthlyPivot && window._exportData.monthlyPivot[2024]) ? window._exportData.monthlyPivot[2024] : {};
  const monthsHdr = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; 
  const pivotAoa = [["Branch", ...monthsHdr, "Total"]];
  const branches = Object.keys(mp2024).sort();
  branches.forEach(branch => {
    const counts = mp2024[branch] || {};
    let total = 0; const row = [branch];
    for(let m=1;m<=12;m++){ const v = counts[m]||0; row.push(v); total += v; }
    row.push(total);
    pivotAoa.push(row);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(pivotAoa), "2024 Monthly Pivot");
  
  XLSX.writeFile(wb, "NotCollected_2024_Monthly_List.xlsx");
});

document.getElementById("download2025MonthlyBtn").addEventListener("click", ()=>{
  if(!window._exportData) return showStatus("No data to download.", "error");
  const list = window._exportData.yearNotCollectedList[2025] || [];
  if(list.length === 0) return showStatus("No 2025 data to download.", "error");
  const wb = XLSX.utils.book_new();
  
  // Sheet 1: Detailed list
  const header = ["Branch","Month","Account","Customer","Master Overdue","Daily Credit","Daily Overdue","Sale Year"];
  const aoa = [header];
  list.forEach(r=>{
    const monthName = ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][typeof r.month === "number"? r.month : 0] || "Unknown";
    aoa.push([r.branch, monthName, r.account, r.customer, r.overdue, r.credit, r.dailyOverdue, r.year]);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), "2025 Not Collected");
  
  // Sheet 2: Monthly pivot summary
  const mp2025 = (window._exportData.monthlyPivot && window._exportData.monthlyPivot[2025]) ? window._exportData.monthlyPivot[2025] : {};
  const monthsHdr = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; 
  const pivotAoa = [["Branch", ...monthsHdr, "Total"]];
  const branches = Object.keys(mp2025).sort();
  branches.forEach(branch => {
    const counts = mp2025[branch] || {};
    let total = 0; const row = [branch];
    for(let m=1;m<=12;m++){ const v = counts[m]||0; row.push(v); total += v; }
    row.push(total);
    pivotAoa.push(row);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(pivotAoa), "2025 Monthly Pivot");
  
  XLSX.writeFile(wb, "NotCollected_2025_Monthly_List.xlsx");
});

// Download 180+ days list
document.getElementById("downloadOverdue180Btn").addEventListener("click", ()=>{
  if(!window._exportData || !window._exportData.overdue180 || window._exportData.overdue180.length===0){
    return showStatus("No 180+ days data to download.", "error");
  }
  const list = window._exportData.overdue180;
  const wb = XLSX.utils.book_new();
  const header = ["Branch","Account","Customer","Sale_Date","Collection Running Month","Closing Balance"];
  const aoa = [header];
  list.forEach(r=>{
    aoa.push([r.branch, r.account, r.customer, r.sale_date, r.months_old, r.closing]);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), "Overdue180Days");
  XLSX.writeFile(wb, "Overdue_180_Plus_Accounts.xlsx");
});

// Download 180‚Äì195 days list
document.getElementById("downloadOverdue180_195Btn").addEventListener("click", ()=>{
  if(!window._exportData || !window._exportData.overdue180_195 || window._exportData.overdue180_195.length===0){
    return showStatus("No 180‚Äì195 days data to download.", "error");
  }
  const list = window._exportData.overdue180_195;
  const wb = XLSX.utils.book_new();
  const header = ["Branch","Account","Customer","Sale_Date","Collection Running Month","Days Old","Closing Balance"];
  const aoa = [header];
  list.forEach(r=>{
    aoa.push([r.branch, r.account, r.customer, r.sale_date, r.months_old, r.days_old, r.closing]);
  });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), "Overdue180_195Days");
  XLSX.writeFile(wb, "Overdue_180_to_195_Days_Accounts.xlsx");
});
</script>
</body>
</html>